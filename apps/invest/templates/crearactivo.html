{% extends 'base.html' %}
{% load static %}

{% block style_css %}
    <style>
        body {
            background-color: #f8f9fa;
        }

        .card {
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .card-header1 {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }

        .form-label {
            font-weight: bold;
        }
    </style>
{% endblock %}

{% block contenido %}
<div class="container mt-5" style="max-width: 100%">
    <h1 class="mb-4 text-center">Crear nuevo activo</h1>
    <div class="row">
        <div class="col-md-12">
            <div class="card" style="max-width:800px">
                <div class="card-body">
                    <form method="post" id="crearActivoForm">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="cartera" class="form-label">Cartera</label>
                                <select class="form-select" id="cartera" name="cartera" required>
                                    <option value="">-- Selecciona una cartera --</option>
                                    {% for cartera in carteras %}
                                        <option value="{{ cartera.id }}">{{ cartera.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label for="tipo" class="form-label">Tipo</label>
                                <select class="form-select" id="tipo" name="tipo">
                                    <option value="NPL">NPL-Cesión de crédito</option>
                                    <option value="CDR">CDR-Cesión de remate</option>
                                    <option value="REO">REO-Compra de activo</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="id_proveedor" class="form-label">ID Proveedor</label>
                                <input type="text" class="form-control" id="id_proveedor" name="id_proveedor" placeholder="ID Proveedor">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="ref_ue" class="form-label">Referencia UE</label>
                                <input type="text" class="form-control" id="ref_ue" name="ref_ue" placeholder="Referencia UE">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="ref_catastral" class="form-label">Referencia Catastral</label>
                                <input type="text" class="form-control" id="ref_catastral" name="ref_catastral" placeholder="Referencia Catastral">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="tipologia" class="form-label">Tipología</label>
                                <select class="form-select" id="tipologia" name="tipologia">
                                    {% for tipologia in tipologias %}
                                        <option value="{{ tipologia.nombre }}">{{ tipologia.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="direccion" class="form-label">Dirección</label>
                            <textarea class="form-control" id="direccion" name="direccion" rows="2" placeholder="Dirección"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="cp" class="form-label">Código Postal</label>
                                <input type="text" class="form-control text-center" id="cp" name="cp" placeholder="Código Postal">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="provincia" class="form-label">Provincia</label>
                                <select class="form-select" id="provincia" name="provincia">
                                    {% for provincia in provincias %}
                                        <option value="{{ provincia.pk }}">{{ provincia.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="poblacion" class="form-label">Población</label>
                                <select class="form-select" id="poblacion" name="poblacion">
                                    <option value="">---------</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="precio" class="form-label">Precio</label>
                                <input
                                type="number"
                                class="form-control text-center"
                                id="precio"
                                name="precio"
                                placeholder="0,00"
                                min="0"
                                step="0.01"   
                                inputmode="decimal"/>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="deuda" class="form-label">Importe de Deuda</label>
                                <input
                                type="number"
                                class="form-control text-center"
                                id="deuda"
                                name="deuda"
                                placeholder="0,00"
                                min="0"
                                step="0.01"   
                                inputmode="decimal"/>
                            </div>
                        </div>
                        <div class="row mb-3">
                        <div class="col-12">
                            <label for="observaciones" class="form-label">Observaciones</label>
                            <textarea
                            id="observaciones"
                            name="observaciones"
                            class="form-control"
                            rows="4"
                            placeholder="Escribe tus observaciones aquí..."></textarea>
                        </div>
                        </div>
                        <div class="text-center">
                            <button type="submit" class="btn btn-success btn-lg">Crear Activo</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById("provincia").addEventListener("change", function () {
        const provinciaId = this.value;
        const poblacionSelect = document.getElementById("poblacion");
        if (provinciaId) {
            fetch(`{% url 'apicampanya' %}?provincia=${provinciaId}&accion=cargar_poblaciones_old`)
                .then(response => response.json())
                .then(data => {
                    poblacionSelect.innerHTML = '<option value="">---------</option>';
                    data.forEach(function (poblacion) {
                        const option = document.createElement("option");
                        option.value = poblacion.id;
                        option.textContent = poblacion.nombre;
                        poblacionSelect.appendChild(option);
                    });
                })
                .catch(error => showAlert("Error al cargar poblaciones:"+ error, 'danger'));
        } else {
            poblacionSelect.innerHTML = '<option value="">---------</option>';
        }
    });

        document.getElementById("crearActivoForm").addEventListener("submit", function (e) {
        e.preventDefault(); // Evita envío normal del formulario

        const csrftoken = getCookie('csrftoken');

        const data = {
            accion: "crear",
            tipo: document.getElementById("tipo").value,
            id_proveedor: document.getElementById("id_proveedor").value,
            ref_ue: document.getElementById("ref_ue").value,
            ref_catastral: document.getElementById("ref_catastral").value,
            tipologia: document.getElementById("tipologia").value,
            direccion: document.getElementById("direccion").value,
            cp: document.getElementById("cp").value,
            poblacion: document.getElementById("poblacion").value,
            provincia: document.getElementById("provincia").value,
            cartera: document.getElementById("cartera").value,
            precio: document.getElementById("precio").value,
            deuda: document.getElementById("deuda").value,
            observaciones: document.getElementById("observaciones").value,

        };

        fetch("/activo/api/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === "success") {
                showAlert("Activo creado correctamente", 'success');
                window.location.href = `/linea/`+result.id+'/editar';
            } else if(result.status === "exists") {
                showAlert("Activo ya existente", 'danger');
                window.location.href = `/linea/`+result.id+'/editar';
            } else {
                showAlert("Error: " + result.message, 'danger');
            }
        })
        .catch(error => {
            showAlert("Error al crear el activo.", 'danger');
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}