{% extends request.htmx|yesno:"base_htmx.html,base.html" %}

{% block contenido %}
    <input type="number" id="txt_micliente_oferta" value='{{micliente}}' class='d-none'>
    <div class="container col-12 d-flex" style="max-width:100%">
    <div class="col-12" id='div_principal_propuestas'>
        <form id="form_filtros_propuestas" class="row g-2 mb-2 align-items-center">
            <div class="col-auto">
                <select class="form-select form-select-sm" id="filtro_estado">
                    <option value="">Estado</option>
                    <option value="I">Interesado</option>
                    <option value="E">Esperando</option>
                    <option value="P">Preparado</option>
                    <option value="R">Reservado</option>
                    <option value="N">No concretado</option>
                    <option value="V">Vendido</option>
                </select>
            </div>
            <div class="col-auto">
                <input type="text" id="filtro_responsable" class="form-control form-control-sm" placeholder="Responsable">
            </div>
            <div class="col-auto">
                <input type="text" id="filtro_cliente" class="form-control form-control-sm" placeholder="Cliente">
            </div>
            <div class="col-auto">
                <input type="text" id="filtro_proveedor" class="form-control form-control-sm" placeholder="ID Prov.">
            </div>
            <div class="col-auto">
                <input type="text" id="filtro_ref_catastral" class="form-control form-control-sm" placeholder="Ref. Cat.">
            </div>
            <div class="col-auto">
                <input type="text" id="filtro_direccion" class="form-control form-control-sm" placeholder="Dirección">
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-primary btn-sm" onclick="ActualizaLista()">Filtrar</button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="LimpiarFiltro()">Limpiar</button>
            </div>
        </form>
        
        
        <div class="table-actions col-12">
            <h1 class='col-10'>Listado de propuestas</h1>
            <div class='col-2'>
                <!-- <button class='btn btn-success' onclick='ImprimirPropuestas()'><i class="bi bi-printer"></i> Imprimir</button> -->
            </div>
        </div>
        <div  scope='col' class="table-responsive" class='col-12'>                
            <table class="table table-striped table-hover col-12">
                <thead class="table-dark">
                    <tr>
                        <th scope="col">
                            Responsable
                        </th>
                        <th scope="col">
                            Cliente 
                        </th>
                        <th scope="col" class="text-center">Propuestas</th>
                        <th scope="col" class="text-center">Activos propuestos</th>
                        <th scope="col" class="text-center">Interesado</th>
                        <th scope="col" class="text-center">Esperando</th>
                        <th scope="col" class="text-center">Preparado</th>
                        <th scope="col" class="text-center">Reservado</th>
                        <th scope="col" class="text-center">No concretado</th>
                        <th scope="col" class="text-center">Vendido</th>
                        <th scope="col"></th>
                    </tr>
                </thead>
                <tbody id='t_body_ofertas' class='col-12'>
                </tbody>
            </table>
        </div>
    </div>
    <div class="col-12 d-none" id='div_secundario_propuestas'>
            <button class='btn btn-info' onclick='MostrarInicio()'><i class="bi bi-arrow-left-square-fill"></i> Volver</button>
            <div class="card text-center">
                <div class="card-header" id='div_card_header_detalle'>
                    <h5 class="card-title" id='h5_titulo_detalle'></h5>
                </div>

            </div>
            <div class="card-body">
                <h5 class="card-title" id='h5_titulo_detalle'></h5>
                <div id="propuestasSeleccionadas" class="alert alert-info" style="display: none;">
                    <strong>Posiciones seleccionadas:</strong>
                    <span id="resumenPropuestas"></span>
                    <div id='botonpropuestasSeleccionadas'>
                        <button type="button" class="btn btn-primary" onclick="pedirInformacionServicer()">Pedir Información al servicer</button>
                    </div>
                </div>
                <table class="table table-striped table-hover col-12">
                    <thead class="table-dark" id='head_tabla_detalle'>
                    </thead>
                    <tbody id='t_body_detalle'>

                    </tbody>
                </table>
              </div>
              <div class="card-footer text-muted" id='div_footer_detalle'>
                
              </div>
            </div>
        </div>
    </div>
<!-- Modal -->
    <div class="modal fade" id="activoModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalle del activo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id='body_activoModal'>
                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Escucha el evento 'hidden.bs.modal' de Bootstrap
        var modal = document.getElementById('activoModal');
        modal.addEventListener('hidden.bs.modal', function () {
            // Selecciona el div con el id 'body_activoModal' y vacía su contenido
            document.getElementById('body_activoModal').innerHTML = '';
        });

        window.onload = function() {
            ActualizaLista();
        };

        function ActualizaLista(){
            const baseUrl = '{{RUTA_PROYECTO}}/propuestas/api/';
            const params = new URLSearchParams({
                accion:'dame_propuestas',
            });
            const url = `${baseUrl}?${params.toString()}`;
            const options = {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json', 
                }
            };
            fetch(url, options)
                .then(response => {return response.json();})
                .then(data => {
                    let tbodyOfertas = document.getElementById('t_body_ofertas');
                    tbodyOfertas.innerHTML = '';
                    tbodyOfertas.innerHTML = data.html
                })
                .catch(error => {
                    showAlert('Error en el fetch: ' + error, 'danger');
                });
        }

        function SeleccionarLineas(id_cliente, estado){
            const baseUrl = '{{RUTA_PROYECTO}}/propuestas/api/';
            const params = new URLSearchParams({
                accion:'dame_propuestas_detalle',
                cliente: id_cliente,
                estado: estado,
                responsable: document.getElementById('filtro_responsable').value,
                filtro_cliente: document.getElementById('filtro_cliente').value,
                proveedor: document.getElementById('filtro_proveedor').value,
                ref_catastral: document.getElementById('filtro_ref_catastral').value,
                direccion: document.getElementById('filtro_direccion').value,
            });
            const url = `${baseUrl}?${params.toString()}`;
            const options = {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json', 
                }
            };
            fetch(url, options)
                .then(response => {return response.json();})
                .then(data => {
                    let thead = document.getElementById('head_tabla_detalle');
                    thead.innerHTML = '';
                    thead.innerHTML = data.html_cabecera

                    let tbody = document.getElementById('t_body_detalle');
                    tbody.innerHTML = '';
                    tbody.innerHTML = data.html

                    let ttitulo = document.getElementById('h5_titulo_detalle');
                    ttitulo.innerHTML = '';
                    ttitulo.innerHTML = data.html_titulo

                    let tpie = document.getElementById('div_footer_detalle');
                    tpie.innerHTML = '';
                    tpie.innerHTML = data.html_pie

                    // alert(data.html_completo)
                    document.getElementById("botonpropuestasSeleccionadas").innerHTML = "";   
                    document.getElementById("botonpropuestasSeleccionadas").insertAdjacentHTML("beforeend", data.texto_boton);

                    document.getElementById('propuestasSeleccionadas').style.display = "none"

                    
                    document.getElementById('div_principal_propuestas').classList.add("d-none")
                    document.getElementById('div_secundario_propuestas').classList.remove("d-none")
                })
                .catch(error => {
                    showAlert('Error en el fetch: ' + error, 'danger');
                });
        }
        function MostrarInicio(){
            document.getElementById('div_principal_propuestas').classList.remove("d-none")
            document.getElementById('div_secundario_propuestas').classList.add("d-none")
        }

        function SeleccionarTodosActivosI() {
            const elementosActivos = document.querySelectorAll('input[name="c_sel_activoI"]');
            const todosActivosCheckeado = document.getElementById('c_sel_todos_activosI').checked;
            elementosActivos.forEach(elemento => {
                if (elemento.checked != todosActivosCheckeado){
                    elemento.checked = todosActivosCheckeado;
                    elemento.dispatchEvent(new Event('change'));
                }
            });
            actualizarResumenModalActivoI()
        }

        function obtenerTextoLabel(checkbox) {
            const label = document.querySelector(`label[for="${checkbox.id}"]`);
            return label ? label.textContent.trim() : "";
        }
        function actualizarResumenModalActivoI(){
            const checkboxes = document.querySelectorAll("input[name='c_sel_activoI']");
            const resumenContainer = document.getElementById("propuestasSeleccionadas");
            const resumenText = document.getElementById("resumenPropuestas");
            const seleccionados = Array.from(checkboxes)
                .filter(checkbox => checkbox.checked) // Solo los checkboxes marcados
                .map(checkbox => obtenerTextoLabel(checkbox)); // Obtener el texto del <label>

            if (seleccionados.length > 0) {
                resumenText.innerHTML = `${seleccionados.length} posiciones seleccionadas: `; //<strong>${seleccionados.join(", ")}</strong>
                resumenContainer.style.display = "block";
            } else {
                resumenContainer.style.display = "none"; // Ocultar si no hay seleccionados
                resumenText.innerHTML = "";
            }
        }
        function pedirInformacionServicer(){
            
            const lineas = document.querySelectorAll('input[name="c_sel_activoI"]:checked');
            const lineasSeleccionadas = []
            lineas.forEach(elemento => {
                lineasSeleccionadas.push(elemento.value);
            })
            const lineasStr = lineasSeleccionadas.join(',');


            fetch('/activo/api/', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ accion:'pedir_info_servicers', lineas_id: lineasStr }),
            })
                .then(data => {
                    window.location.reload()
                })
                .catch(error => {
                    showAlert('Error en el fetch: ' + error, 'danger');
                });
        }
/*ESPERANDO*/
    function Activo_Preparado(propuestalinea_id, linea_id, activo_id){
        const baseUrl = '{{RUTA_PROYECTO}}/campanya/api/';
        const params = new URLSearchParams({
            accion:'activopreparado',
            linea:linea_id,
            activo:activo_id
        });
        const url = `${baseUrl}?${params.toString()}`;
        const options = {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json', 
            }
        };
        fetch(url, options)
            .then(response => {
                if (!response.ok) {
                    showAlert('Error en la solicitud: ' + response.statusText, 'danger');
                    throw new Error('Error en la solicitud: ' + response.statusText);
                }
                return response.json(); // Convertimos la respuesta a JSON
            })
            .then(data => {
                if(data.error){
                    showAlert(data.literror, 'danger');
                }else{
                    const boton = document.querySelector('#td_bot_preparado_'+ propuestalinea_id + ' button');
                    const textoBoton = boton.textContent;
                    const label = document.createElement('label');
                    label.textContent = "Preparado";
                    label.style.cssText = 'color: green; font-weight: bold;';
                    boton.parentNode.replaceChild(label, boton);

                    // let id_cliente=document.getElementById("txt_cliente_seleccionado").value
                    // SeleccionarLineas(id_cliente, "E")
                }
            })
            .catch(error => {
                showAlert('Error en el fetch: ' + error, 'danger');
            });
    }

    function SeleccionarTodosActivosE() {
        const elementosActivos = document.querySelectorAll('input[name="c_sel_activoE"]');
        const todosActivosCheckeado = document.getElementById('c_sel_todos_activosE').checked;
        elementosActivos.forEach(elemento => {
            if (elemento.checked != todosActivosCheckeado){
                elemento.checked = todosActivosCheckeado;
                elemento.dispatchEvent(new Event('change'));
            }
        });
        actualizarResumenModalActivoE()
    }
    function actualizarResumenModalActivoE(){
        const checkboxes = document.querySelectorAll("input[name='c_sel_activoE']");
        const resumenContainer = document.getElementById("propuestasSeleccionadas");
        const resumenText = document.getElementById("resumenPropuestas");
        const seleccionados = Array.from(checkboxes)
            .filter(checkbox => checkbox.checked) // Solo los checkboxes marcados
            .map(checkbox => obtenerTextoLabel(checkbox)); // Obtener el texto del <label>

        if (seleccionados.length > 0) {
            resumenText.innerHTML = `${seleccionados.length} posiciones seleccionadas: `; //<strong>${seleccionados.join(", ")}</strong>
            resumenContainer.style.display = "block";
        } else {
            resumenContainer.style.display = "none"; // Ocultar si no hay seleccionados
            resumenText.innerHTML = "";
        }
    }

    function enviarInformacionCliente(){        
        const lineas = document.querySelectorAll('input[name="c_sel_activoE"]:checked');
        const lineasSeleccionadas = []
        lineas.forEach(elemento => {
            lineasSeleccionadas.push(elemento.value);
        })
        const lineasStr = lineasSeleccionadas.join(',');


        fetch('/activo/api/', {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ accion:'enviar_info_clientes', lineas_id: lineasStr }),
        })
            .then(data => {
                window.location.reload();
                //let id_cliente=document.getElementById("txt_cliente_seleccionado").value
                //SeleccionarLineas(id_cliente, "E")
            })
            .catch(error => {
                showAlert('Error en el fetch: ' + error, 'danger');
            });
    }

    function AnularPropuesta(id_propuesta){            
        if (confirm("¿Desea realmente eliminar esta propuesta?")){                
            fetch('/propuestas/api/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({ accion: 'anular_propuesta', propuesta_id: id_propuesta }),
            })
            .then(response => {
                if (response.ok) {
                    return response.json(); // Procesar la respuesta si es necesario
                } else {
                    throw new Error('Error en la solicitud al servidor');
                }
            })
            .then(data => {
                window.location.reload(); // Corrección del método
            })
            .catch(error => {
                showAlert('Error al enviar las propuestas: ' + error, 'danger');
            });            
        }
    }
    function ImprimirPropuesta(id_propuesta){            
        fetch('/propuestas/api/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({ accion: 'imprimir_propuesta', propuesta_id: id_propuesta }),
        })
        .then(response => {
            if (response.ok) {
                return response.json(); // Procesar la respuesta si es necesario
            } else {
                throw new Error('Error en la solicitud al servidor');
            }
        })
        .then(data => {
            window.open('{{RUTA_PROYECTO}}/media/' + data.nombrefichero);
        })
        .catch(error => {
            showAlert('Error al imprimir las propuestas: ' + error, 'danger');
        });            
    }

    function ActualizaLista() {
        const params = new URLSearchParams({
            accion: 'filtrar_propuestas',
            estado: document.getElementById('filtro_estado').value,
            responsable: document.getElementById('filtro_responsable').value,
            cliente: document.getElementById('filtro_cliente').value,
            proveedor: document.getElementById('filtro_proveedor').value,
            ref_catastral: document.getElementById('filtro_ref_catastral').value,
            direccion: document.getElementById('filtro_direccion').value,
        });
    
        fetch(`{{RUTA_PROYECTO}}/propuestas/api/?${params}`, { method: 'GET' })
            .then(res => res.json())
            .then(data => document.getElementById('t_body_ofertas').innerHTML = data.html)
            .catch(err => showAlert('Error al filtrar: ' + err, 'danger'));
    }
    
    function LimpiarFiltro() {
        ['filtro_estado', 'filtro_responsable', 'filtro_cliente', 'filtro_proveedor', 'filtro_ref_catastral', 'filtro_direccion']
            .forEach(id => document.getElementById(id).value = '');
        ActualizaLista();
    }
    
    
    </script>
{% endblock %}

